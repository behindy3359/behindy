name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Cleanup and checkout
        run: |
          echo "ğŸ§¹ ì •ë¦¬ ë° ì½”ë“œ ë™ê¸°í™”..."
          docker system prune -f
          cd ~/behindy
          git fetch origin
          git reset --hard origin/main

      - name: Smart rebuild
        run: |
          cd ~/behindy
          echo "ğŸ” ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."
          
          CHANGED_FILES=$(git diff HEAD~1 --name-only)
          
          docker-compose down --timeout 10
          
          if echo "$CHANGED_FILES" | grep -q "backend/"; then
            echo "ğŸ“¦ ë°±ì—”ë“œ ë¦¬ë¹Œë“œ..."
            docker-compose build backend
          fi
          
          if echo "$CHANGED_FILES" | grep -q "frontend/"; then
            echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ë¦¬ë¹Œë“œ..."
            docker-compose build frontend
          fi
          
          if echo "$CHANGED_FILES" | grep -q "aiserver/"; then
            echo "ğŸ“¦ AIì„œë²„ ë¦¬ë¹Œë“œ..."
            docker-compose build aiserver
          fi
          
          if echo "$CHANGED_FILES" | grep -qE "(docker-compose|Dockerfile|nginx)"; then
            echo "ğŸ“¦ ì „ì²´ ë¦¬ë¹Œë“œ..."
            docker-compose build
          fi

      - name: Start services with health checks
        run: |
          cd ~/behindy
          echo "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘..."
          
          docker-compose up -d postgres redis
          
          wait_for_db() {
            for i in {1..30}; do
              if docker-compose exec -T postgres pg_isready -U ${DB_USER:-behindy} -d ${DB_NAME:-behindy} >/dev/null 2>&1; then
                echo "âœ… DB ì¤€ë¹„ ì™„ë£Œ! ($iì´ˆ)"
                return 0
              fi
              echo "â³ DB ëŒ€ê¸° ì¤‘... ($i/30)"
              sleep 2
            done
            echo "âŒ DB ì—°ê²° ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸:"
            docker-compose logs --tail=5 postgres
            return 1
          }
          
          if wait_for_db; then
            docker-compose up -d backend
            
            wait_for_backend() {
              for i in {1..60}; do
                if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
                  echo "âœ… ë°±ì—”ë“œ ì¤€ë¹„ ì™„ë£Œ! ($iì´ˆ)"
                  return 0
                fi
                if [ $i -eq 30 ]; then
                  echo "âš ï¸  ë°±ì—”ë“œ ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤. ë¡œê·¸ í™•ì¸:"
                  docker-compose logs --tail=10 backend
                fi
                echo "â³ ë°±ì—”ë“œ ëŒ€ê¸° ì¤‘... ($i/60)"
                sleep 2
              done
              echo "âŒ ë°±ì—”ë“œ ì‹œì‘ ì‹¤íŒ¨ - ìƒì„¸ ë¡œê·¸:"
              docker-compose logs --tail=20 backend
              return 1
            }
            
            if wait_for_backend; then
              docker-compose up -d
              
              echo "ğŸ¤– AIì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘..."
              sleep 5
              if curl -f http://localhost:8000/health >/dev/null 2>&1; then
                echo "âœ… AIì„œë²„ ì •ìƒ ë™ì‘"
              else
                echo "âš ï¸  AIì„œë²„ ì‘ë‹µ ì—†ìŒ (ì •ìƒ - ë°±ì—”ë“œëŠ” Mockìœ¼ë¡œ ë™ì‘)"
              fi
              
              echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
            else
              echo "âŒ ë°±ì—”ë“œ ì‹œì‘ ì‹¤íŒ¨"
              exit 1
            fi
          else
            echo "âŒ DB ì‹œì‘ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Final health check
        run: |
          echo "ğŸ” ìµœì¢… í—¬ìŠ¤ì²´í¬..."
          
          for i in {1..30}; do
            if curl -f http://localhost:3000/ >/dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì¤€ë¹„ ì™„ë£Œ! ($iì´ˆ)"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "âš ï¸  í”„ë¡ íŠ¸ì—”ë“œ ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤. ë¡œê·¸ í™•ì¸:"
              docker-compose logs --tail=10 frontend
            fi
            echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done
          
          for i in {1..15}; do
            if curl -f http://localhost/ >/dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ! ($iì´ˆ)"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âš ï¸  Nginx ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤. ìƒíƒœ í™•ì¸:"
              docker-compose ps nginx
            fi
            echo "â³ Nginx ëŒ€ê¸° ì¤‘... ($i/15)"
            sleep 2
          done

      - name: Status report
        run: |
          cd ~/behindy
          echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
          docker-compose ps
          
          echo ""
          echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸:"
          curl -s http://localhost:8080/actuator/health | head -c 200 || echo "ë°±ì—”ë“œ ì‘ë‹µ ì—†ìŒ"
          
          echo ""
          echo "ğŸ” ì§€í•˜ì²  API ìƒíƒœ í™•ì¸:"
          curl -s http://localhost:8080/api/metro/status | head -c 300 || echo "ì§€í•˜ì²  API ì‘ë‹µ ì—†ìŒ"
          
          echo ""
          echo "ğŸ¤– AIì„œë²„ ìƒíƒœ í™•ì¸:"
          curl -s http://localhost:8000/health | head -c 300 || echo "AIì„œë²„ ì‘ë‹µ ì—†ìŒ (ì •ìƒ - Mock ëª¨ë“œ)"
          
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "ì„œë²„IP")
          echo ""
          echo "ğŸ”— ì ‘ì† URL: http://$PUBLIC_IP/"

      - name: Cleanup
        run: |
          docker image prune -f
          docker volume prune -f

      - name: Error logs
        if: failure()
        run: |
          cd ~/behindy
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ ë¡œê·¸:"
          echo "=== ë°±ì—”ë“œ ë¡œê·¸ ==="
          docker-compose logs --tail=30 backend
          echo ""
          echo "=== í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ ==="
          docker-compose logs --tail=20 frontend
          echo ""
          echo "=== AIì„œë²„ ë¡œê·¸ ==="
          docker-compose logs --tail=10 aiserver