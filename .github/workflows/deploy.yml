name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Free up disk space
        run: |
          echo "=== ë°°í¬ ì „ ë””ìŠ¤í¬ ì •ë¦¬ ==="
          df -h
          
          docker system prune -f --volumes
          docker image prune -a -f
          
          sudo apt autoremove -y
          sudo apt autoclean
          
          echo "=== ì •ë¦¬ í›„ ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Force sync latest code
        run: |
          cd ~/behindy
          git fetch origin
          git reset --hard origin/main
          echo "[+] Force sync complete"

      - name: Stop existing containers
        run: |
          cd ~/behindy
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
          
          # ì»¨í…Œì´ë„ˆ graceful ì¤‘ì§€ (30ì´ˆ íƒ€ì„ì•„ì›ƒ)
          docker-compose down --timeout 30 || true
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì™„ë£Œ"

      - name: Clean up old images
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ë“¤ ì •ë¦¬
          docker image prune -f
          
          # behindy ê´€ë ¨ ì´ë¯¸ì§€ë“¤ ì •ë¦¬
          docker images | grep behindy | awk '{print $3}' | xargs -r docker rmi -f || true
          
          echo "âœ… ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

      - name: Build and start services
        run: |
          cd ~/behindy
          echo "ğŸ—ï¸ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘ ì¤‘..."
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ
          if [ -f .env ]; then
            echo "ğŸ“‹ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ ì¤‘..."
            set -a
            source .env
            set +a
          else
            echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Docker Compose ê¸°ë³¸ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          fi
          
          # ëª¨ë“  ì„œë¹„ìŠ¤ ìºì‹œ ì—†ì´ ìƒˆë¡œ ë¹Œë“œ
          echo "ğŸ“¦ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì¤‘..."
          docker-compose build --no-cache
          
          # ë‹¨ê³„ë³„ ì‹œì‘: ë¨¼ì € DBì™€ Redis
          echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë° Redis ì‹œì‘..."
          docker-compose up -d db redis
          
          # PostgreSQL ì¤€ë¹„ ëŒ€ê¸° (SpringBoot DataInitializerê°€ ì²˜ë¦¬)
          echo "â³ PostgreSQL ì¤€ë¹„ ëŒ€ê¸°..."
          sleep 20
          
          # ë°±ì—”ë“œ ì‹œì‘ (JPA í…Œì´ë¸” ìƒì„± + ì´ˆê¸° ë°ì´í„° ìë™ ë¡œë“œ)
          echo "ğŸš€ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘..."
          docker-compose up -d backend
          
          # ë°±ì—”ë“œ ì•ˆì •í™” ëŒ€ê¸° (ì´ˆê¸° ë°ì´í„° ë¡œë”© í¬í•¨)
          echo "â³ ë°±ì—”ë“œ ì•ˆì •í™” ë° ì´ˆê¸° ë°ì´í„° ë¡œë”© ëŒ€ê¸°..."
          sleep 30
          
          # ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸš€ ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ ì‹œì‘..."
          docker-compose up -d
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹œì‘ ì™„ë£Œ"

      - name: Wait for services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          cd ~/behindy
          docker-compose ps

      - name: Health check
        run: |
          echo "=== í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ==="
          sleep 30
          
          if curl -f http://localhost/; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            cd ~/behindy
            docker-compose logs
            exit 1
          fi

      - name: Display service status
        run: |
          cd ~/behindy
          echo "=== ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ ==="
          
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose ps
          
          echo ""
          echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h
          
          echo ""
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ëª©ë¡:"
          docker images | head -10
          
          echo ""
          echo "ğŸ”— ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´:"
          # IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || curl -s ipinfo.io/ip 2>/dev/null || curl -s icanhazip.com 2>/dev/null || echo "ì„œë²„IP")
          echo "  - í”„ë¡ íŠ¸ì—”ë“œ: http://$PUBLIC_IP/"
          echo "  - ë°±ì—”ë“œ API: http://$PUBLIC_IP:8080/"
          echo "  - AI ì„œë¹„ìŠ¤: http://$PUBLIC_IP:8000/"

      - name: Final cleanup
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ìµœì¢… ì •ë¦¬ ì‘ì—…..."
          
          # ë¹Œë“œ ìºì‹œ ì •ë¦¬
          docker builder prune -f
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
          docker volume prune -f
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬  
          docker network prune -f
          
          echo "=== ìµœì¢… ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ ì •ë³´:"
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
          cd ~/behindy
          docker-compose ps || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (frontend) ==="
          docker-compose logs --tail=50 frontend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (backend) ==="  
          docker-compose logs --tail=50 backend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (nginx) ==="
          docker-compose logs --tail=50 nginx || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (aiserver) ==="
          docker-compose logs --tail=50 aiserver || true