name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Free up disk space
        run: |
          echo "=== ë°°í¬ ì „ ë””ìŠ¤í¬ ì •ë¦¬ ==="
          df -h
          
          docker system prune -f --volumes
          docker image prune -a -f
          
          sudo apt autoremove -y
          sudo apt autoclean
          
          echo "=== ì •ë¦¬ í›„ ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Force sync latest code
        run: |
          cd ~/behindy
          git fetch origin
          git reset --hard origin/main
          echo "[+] Force sync complete"

      - name: Stop existing containers
        run: |
          cd ~/behindy
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬ ì¤‘..."
          
          # 1. Docker Compose ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          docker-compose down --timeout 30 || true
          
          # 2. behindy ê´€ë ¨ ëª¨ë“  ì»¨í…Œì´ë„ˆ ê°•ì œ ì¤‘ì§€ ë° ì œê±°
          echo "ğŸ“‹ behindy ê´€ë ¨ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸:"
          docker ps | grep behindy || echo "behindy ì»¨í…Œì´ë„ˆ ì—†ìŒ"
          
          echo "ğŸ—‘ï¸ behindy ê´€ë ¨ ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°:"
          docker ps -a | grep behindy | awk '{print $1}' | xargs -r docker stop || true
          docker ps -a | grep behindy | awk '{print $1}' | xargs -r docker rm -f || true
          
          # 3. í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸ ë° ì •ë¦¬
          echo "ğŸ” í¬íŠ¸ 8000, 8080 ì‚¬ìš© ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸:"
          docker ps | grep ":8000\|:8080" || echo "í•´ë‹¹ í¬íŠ¸ ì‚¬ìš© ì»¨í…Œì´ë„ˆ ì—†ìŒ"
          
          # 4. aiserver, llmserver ì´ë¦„ í¬í•¨ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ğŸ§¹ AI/LLM ì„œë²„ ê´€ë ¨ ì»¨í…Œì´ë„ˆ ì •ë¦¬:"
          docker ps -a | grep -E "(aiserver|llmserver)" | awk '{print $1}' | xargs -r docker stop || true
          docker ps -a | grep -E "(aiserver|llmserver)" | awk '{print $1}' | xargs -r docker rm -f || true
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"
          echo "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
          docker ps

      - name: Clean up old images
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          
          docker image prune -f
          
          docker images | grep behindy | awk '{print $3}' | xargs -r docker rmi -f || true
          
          echo "âœ… ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

      - name: Build and start containers
        run: |
          cd ~/behindy
          echo "ğŸ—ï¸ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘ ì¤‘..."

          if [ -f .env ]; then
            echo "ğŸ“‹ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ ì¤‘..."
            set -a
            source .env
            set +a
          else
            echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Docker Compose ê¸°ë³¸ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          fi

          # Docker BuildKit í™œì„±í™” ë° ë¹Œë“œ ë©”ëª¨ë¦¬ ìµœì í™”
          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1

          echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ (ìºì‹œ í™œìš©)..."
          # --no-cache ì œê±°í•˜ì—¬ ìºì‹œ í™œìš©, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ
          docker-compose build frontend

          echo "ğŸ“¦ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ ë¹Œë“œ ì¤‘..."
          docker-compose build backend llmserver

          echo "ğŸš€ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          docker-compose up -d

          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹œì‘ ì™„ë£Œ"

      - name: Wait for services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          cd ~/behindy
          docker-compose ps

      - name: Health check
        run: |
          echo "=== í—¬ìŠ¤ì²´í¬ ì§„í–‰ ==="
          cd ~/behindy
          
          echo "â³ DB ì¤€ë¹„ ëŒ€ê¸°..."
          for i in {1..20}; do
            if docker-compose exec -T postgres pg_isready -U ${DB_USER:-behindy} -d ${DB_NAME:-behindy} >/dev/null 2>&1; then
              echo "âœ… DB ì¤€ë¹„ ì™„ë£Œ! ($i/20)"
              break
            fi
            echo "DB ëŒ€ê¸° ì¤‘... ($i/20)"
            sleep 3
          done
          
          echo "â³ ë°±ì—”ë“œ API ëŒ€ê¸°..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ API ì¤€ë¹„ ì™„ë£Œ! ($i/30)"
              break
            fi
            echo "ë°±ì—”ë“œ ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done
          
          echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ê¸°..."
          for i in {1..20}; do
            if curl -f http://localhost:3000/ >/dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì¤€ë¹„ ì™„ë£Œ! ($i/20)"
              break
            fi
            echo "í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ê¸° ì¤‘... ($i/20)"
            sleep 2
          done
          
          echo "â³ AI ì„œë²„ ëŒ€ê¸°..."
          for i in {1..20}; do
            if curl -f http://localhost:8000/health >/dev/null 2>&1; then
              echo "âœ… AI ì„œë²„ ì¤€ë¹„ ì™„ë£Œ! ($i/20)"
              break
            fi
            echo "AI ì„œë²„ ëŒ€ê¸° ì¤‘... ($i/20)"
            sleep 2
          done
          
          echo "â³ ìµœì¢… í—¬ìŠ¤ì²´í¬..."
          sleep 10
          
          if curl -f http://localhost/ >/dev/null 2>&1; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          elif curl -f http://localhost:3000/ >/dev/null 2>&1; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ ì ‘ê·¼ ì„±ê³µ! (Nginx ìš°íšŒ)"
            echo "âš ï¸  Nginx SSL ì„¤ì • í™•ì¸ í•„ìš”"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            echo "=== Nginx ìƒíƒœ í™•ì¸ ==="
            docker-compose ps nginx
            echo "=== Nginx ë¡œê·¸ ==="
            docker-compose logs --tail=10 nginx
            exit 1
          fi

      - name: Display service status
        run: |
          cd ~/behindy
          echo "=== ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ ==="
          
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose ps
          
          echo ""
          echo "ğŸ” ì„œë¹„ìŠ¤ ì‘ë‹µ í™•ì¸:"
          echo -n "ë°±ì—”ë“œ API: "
          curl -s http://localhost:8080/actuator/health | head -c 50 || echo "ì‘ë‹µ ì—†ìŒ"
          echo ""
          echo -n "ì§€í•˜ì²  API: "
          curl -s http://localhost:8080/api/metro/status | head -c 100 || echo "ì‘ë‹µ ì—†ìŒ"
          echo ""
          echo -n "AIì„œë²„: "
          curl -s http://localhost:8000/health | head -c 50 || echo "ì‘ë‹µ ì—†ìŒ"
          echo ""
          echo -n "AI ì—°ë™: "
          curl -s http://localhost:8080/api/ai-stories/health | head -c 100 || echo "ì‘ë‹µ ì—†ìŒ"
          
          echo ""
          echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h
          
          echo ""
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ëª©ë¡:"
          docker images | head -10
          
          echo ""
          echo "ğŸ”— ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´:"
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || curl -s ipinfo.io/ip 2>/dev/null || curl -s icanhazip.com 2>/dev/null || echo "ì„œë²„IP")
          echo "  - í”„ë¡ íŠ¸ì—”ë“œ: http://$PUBLIC_IP/"
          echo "  - ë°±ì—”ë“œ API: http://$PUBLIC_IP:8080/"
          echo "  - AI ì„œë¹„ìŠ¤: http://$PUBLIC_IP:8000/"

      - name: Final cleanup
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ìµœì¢… ì •ë¦¬ ì‘ì—…..."
          
          docker builder prune -f
          docker volume prune -f
          docker network prune -f
          
          echo "=== ìµœì¢… ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ ì •ë³´:"
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
          cd ~/behindy
          docker-compose ps || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (postgres) ==="
          docker-compose logs --tail=20 postgres || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (backend) ==="  
          docker-compose logs --tail=30 backend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (frontend) ==="
          docker-compose logs --tail=20 frontend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (nginx) ==="
          docker-compose logs --tail=15 nginx || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (llmserver) ==="
          docker-compose logs --tail=15 llmserver || true