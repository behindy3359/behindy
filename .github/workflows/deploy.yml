name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Free up disk space
        run: |
          echo "=== ë°°í¬ ì „ ë””ìŠ¤í¬ ì •ë¦¬ ==="
          df -h
          
          docker system prune -f --volumes
          docker image prune -a -f
          
          sudo apt autoremove -y
          sudo apt autoclean
          
          echo "=== ì •ë¦¬ í›„ ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Force sync latest code
        run: |
          cd ~/behindy
          git fetch origin
          git reset --hard origin/main
          echo "[+] Force sync complete"

      - name: Verify environment file
        run: |
          cd ~/behindy
          
          # ğŸ”¥ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ“‹ .env.exampleì„ ì°¸ê³ í•˜ì—¬ .env íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”."
            echo ""
            echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
            echo "cp .env.example .env"
            echo "nano .env  # ì‹¤ì œ ê°’ë“¤ë¡œ í¸ì§‘"
            exit 1
          fi
          
          # ğŸ”¥ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "âœ… .env íŒŒì¼ í™•ì¸ë¨"
          echo "ğŸ” í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
          
          source .env
          
          # Next.js ë¹Œë“œì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë“¤ í™•ì¸
          required_vars=(
            "NEXT_PUBLIC_API_URL"
            "NEXT_PUBLIC_AI_URL" 
            "NEXT_PUBLIC_TOKEN_KEY"
            "NEXT_PUBLIC_REFRESH_TOKEN_KEY"
            "NEXT_PUBLIC_APP_NAME"
            "NEXT_PUBLIC_APP_VERSION"
            "DB_USER"
            "DB_PASS"
            "DB_NAME"
            "REDIS_PASSWORD"
            "JWT_SECRET"
          )
          
          missing_vars=()
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "âŒ ë‹¤ìŒ í™˜ê²½ë³€ìˆ˜ë“¤ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:"
            printf '%s\n' "${missing_vars[@]}"
            echo ""
            echo "ğŸ“‹ .env íŒŒì¼ì—ì„œ í•´ë‹¹ ë³€ìˆ˜ë“¤ì„ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # ğŸ”¥ í™˜ê²½ë³€ìˆ˜ ê°’ ê²€ì¦ (ë¯¼ê°ì •ë³´ ì œì™¸)
          echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸:"
          echo "  - NEXT_PUBLIC_API_URL: $NEXT_PUBLIC_API_URL"
          echo "  - NEXT_PUBLIC_AI_URL: $NEXT_PUBLIC_AI_URL"
          echo "  - NEXT_PUBLIC_APP_NAME: $NEXT_PUBLIC_APP_NAME"
          echo "  - NEXT_PUBLIC_APP_VERSION: $NEXT_PUBLIC_APP_VERSION"
          echo "  - DB_NAME: $DB_NAME"
          echo "  - DB_USER: $DB_USER"

      - name: Stop existing containers
        run: |
          cd ~/behindy
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
          
          # ì»¨í…Œì´ë„ˆ graceful ì¤‘ì§€ (30ì´ˆ íƒ€ì„ì•„ì›ƒ)
          docker-compose down --timeout 30
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì™„ë£Œ"

      - name: Clean up old images
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ë“¤ ì •ë¦¬
          docker image prune -f
          
          # behindy ê´€ë ¨ ì´ë¯¸ì§€ë“¤ ì •ë¦¬ (latest íƒœê·¸ê°€ ì•„ë‹Œ ê²ƒë“¤)
          docker images | grep behindy | grep -v latest | awk '{print $3}' | xargs -r docker rmi -f || true
          
          echo "âœ… ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

      - name: Build and start containers
        run: |
          cd ~/behindy
          echo "ğŸ—ï¸ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘ ì¤‘..."
          
          # ğŸ”¥ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œí•˜ì—¬ ë¹Œë“œ
          set -a  # ëª¨ë“  ë³€ìˆ˜ë¥¼ export
          source .env
          set +a
          
          # ë¹Œë“œ ìºì‹œ ì—†ì´ ìƒˆë¡œ ë¹Œë“œ (frontendë§Œ)
          echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ìƒˆë¡œ ë¹Œë“œ ì¤‘..."
          docker-compose build --no-cache frontend
          
          # ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ì€ ìºì‹œ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ
          echo "ğŸ“¦ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ ë¹Œë“œ ì¤‘..."
          docker-compose build backend aiserver
          
          # ëª¨ë“  ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸš€ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          docker-compose up -d
          
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹œì‘ ì™„ë£Œ"

      - name: Wait for services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 15
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          docker-compose ps

      - name: Health check
        run: |
          cd ~/behindy
          echo "=== í—¬ìŠ¤ì²´í¬ ì‹œì‘ ==="
          
          # ğŸ”¥ ê°œë³„ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
          echo "ğŸ” ë°±ì—”ë“œ ì„œë¹„ìŠ¤ í™•ì¸..."
          for i in {1..12}; do  # ìµœëŒ€ 1ë¶„ ëŒ€ê¸°
            if curl -f -s http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ"
              break
            elif [ $i -eq 12 ]; then
              echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ"
              docker-compose logs backend
              exit 1
            else
              echo "â³ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ëŒ€ê¸° ì¤‘... ($i/12)"
              sleep 5
            fi
          done
          
          echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ í™•ì¸..."
          for i in {1..12}; do  # ìµœëŒ€ 1ë¶„ ëŒ€ê¸°
            if curl -f -s http://localhost/ >/dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ"
              break
            elif [ $i -eq 12 ]; then
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ"
              docker-compose logs frontend
              docker-compose logs nginx
              exit 1
            else
              echo "â³ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ëŒ€ê¸° ì¤‘... ($i/12)"
              sleep 5
            fi
          done
          
          echo "ğŸ” AI ì„œë¹„ìŠ¤ í™•ì¸..."
          if curl -f -s http://localhost:8000/ >/dev/null 2>&1; then
            echo "âœ… AI ì„œë¹„ìŠ¤ ì •ìƒ"
          else
            echo "âš ï¸ AI ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ (ì„ íƒì  ì„œë¹„ìŠ¤)"
          fi
          
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"

      - name: Display service status
        run: |
          cd ~/behindy
          echo "=== ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ ==="
          
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker-compose ps
          
          echo ""
          echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h
          
          echo ""
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ëª©ë¡:"
          docker images | head -10
          
          echo ""
          echo "ğŸ”— ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´:"
          echo "  - í”„ë¡ íŠ¸ì—”ë“œ: http://$(curl -s ifconfig.me)/"
          echo "  - ë°±ì—”ë“œ API: http://$(curl -s ifconfig.me):8080/"
          echo "  - AI ì„œë¹„ìŠ¤: http://$(curl -s ifconfig.me):8000/"

      - name: Final cleanup
        run: |
          cd ~/behindy
          echo "ğŸ§¹ ìµœì¢… ì •ë¦¬ ì‘ì—…..."
          
          # ë¹Œë“œ ìºì‹œ ì •ë¦¬
          docker builder prune -f
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
          docker volume prune -f
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬  
          docker network prune -f
          
          echo "=== ìµœì¢… ë””ìŠ¤í¬ ìƒíƒœ ==="
          df -h
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ ì •ë³´:"
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
          docker-compose ps || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (frontend) ==="
          docker-compose logs --tail=50 frontend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (backend) ==="  
          docker-compose logs --tail=50 backend || true
          echo ""
          echo "=== ìµœê·¼ ë¡œê·¸ (nginx) ==="
          docker-compose logs --tail=50 nginx || true